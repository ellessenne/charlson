---
title: "Comorbidity ahrq updates"
author: "Alexander Fiksdal"
date: "4/22/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# April 22 Update

From email on 4/20/20:

Source of the R package: https://github.com/ellessenne/comorbidity
The file you would update is the ./data-raw/mark-data.R file (and possibly some other files so that the newly defined “elixhauser_ahrq” score would be invokable from the main “comorbidity” function.
Don’t worry about documentation for now.
 
Source of the SAS version: https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comorbidity_icd10.jsp
Specifically, this file: https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2020_1.txt
 
Deliverables:
 
Confirm that the R version matches the SAS version
Fork the R package and update it such that it can calculate comorbidities using this new version of Elixhauser comorbidity metric
 
We will check in on Wednesday to see where you are.

## Confirm that the R version matches the SAS version

This required consulting the following resources:

*  Elixhauser_AHRQ_v20192.txt (from email)
*  https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comorbidity_icd10.jsp
*  https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2020_1.txt
*  https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comoanaly_icd10cm_2020_1.txt

In short, the Elixhauser_AHRQ_v20192 file did not match what was specified in the SAS code. Specifically, the SAS code initially groups ICD10 codes into more groups than the Elixhauser approach uses in the end. It then uses some conditional logic to assign '1' to one _or more_ traditional groups, depending on the code (see "Initialize Hypertension, CHF, and Renal Comorbidity flags to 1 using the detail hypertension flags" in the comoanaly_icd10cm_2020_1.txt file for examples). Sean's approach moved all codes from the extra groups to traditional ones, but not always in a way that reproduces the SAS code. For example, the ICD10 code 'I132' was assigned to the group 'HHRWHRF' in the SAS code (which is not directly used to calculate the final score). Sean assigned that code to 'hypertension, complicated (hypc)' instead. However, the comoanaly_icd10cm_2020_1 SAS code conditionally assigns 1 to 3 groups if 'I132' is indicated (see code below). Note that naming conventions in SAS are a little different, but those 3 groups are used to directly calculate the final score.

```{r eval=F}
# From SAS code:
IF HHRWHRF_  THEN DO;
	   HTNCX    = 1;
	   CHF      = 1;
	   RENLFAIL = 1;
END;
```

Also, while I didn't comprehensively search the Elixhauser_AHRQ_v20192 document, I did notice a couple missing codes as well (e.g. 'E40' missing from 'wloss').

## Fork the R package and update it such that it can calculate comorbidities using this new version of Elixhauser comorbidity metric

This is in progress and needs to be checked/validated, but I have a forked version in my github (https://github.com/fiksdala/comorbidity) and have updated it to be able to calculate scores using "score='elixhauser_ahrq'". I'm not sure the calculations are correct yet, though. Here's a summary of what I've done so far:

*  Updated data-raw/make-data.R to include groups for elixhauser_ahrq
*  Included convert_sas.R in /data-raw/ which details how I extracted codes from SAS
    * This code requires 'https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2020_1.txt' to be in the data-raw folder, and writes the file 'ahrq_sas_conversion_af.txt' to the same folder when executed, which contains the text I have manually added to make-data.R. When make-data.R is executed, both those .txt files are deleted. Will probably have to revisit this eventually.
*  Updated R/comorbidity.R to apply the conditional logic of the comoanaly_icd10cm_2020_1 SAS file described above, rename columns to previous naming conventions, drop the extra columns, and calculate results **based on the old elixhauser calculations**
*  Updated check_output.R to recognize addition of elixhauser_ahrq and avoid unexpected state errors.

There are a few issues that need to be addressed moving forward:

*  __DRG groups are used to adjust comorbidities in the SAS files, but not in the R package.__ In the SAS program, some comorbidity indicators are removed if there are DRG codes related to the comorbidity. I think this is to ensure that codes related to primary diagnoses are not considered comorbidities? The comorbidity package doesn't deal with DRGs as far as I can tell so not sure if we need to do anything about that.
*  __Cardiac arrhythmias ('carit') are not included at all in the SAS code__, however they are used to calculate the old elixhauser scores. As far as I can tell, those ICD10 codes are not assigned at all, which seems odd. In order to keep the same calculations, I created an empty 'carit' column for elixhauser_ahrq, but that doesn't seem like a proper solution.
    * According to Moore et al. (2017), this was removed because it is often an acute diagnosis rather than a comorbidity. I will delete this column from the output and calculations in the next update.
*  __How should I calculated elixhauser_ahrq?__ For now I just used the same scoring as the old ahrq, but I'm not sure if that's correct.
    * After consulting the vignettes, I think these are still accurate.
*  __Big differences between elixhauser and elixhauser_ahrq.__ See below for an example, but I'm guessing there's something wrong with how things are now since a test run shows some pretty big differences that can occur.
    * After doing some checks, I haven't found anything wrong with the updated mappings, so I think it's correct. Will have to try out some test cases to be sure.
*  __General cleanup:__ Less urgent, but I know some of code could use some tidying up.
    * To do: add ID, fix how convert_sas is incorporated into make-data.R, check on/fix dplyr dependency in make-data.R (with rename)

## Example

I'll walk through a quick example of the updated ahrq and compare to the old elixhauser results.

```{r include=F}
library(devtools)
library(tidyverse)
install_github("fiksdala/comorbidity")
library(comorbidity)
```

```{r}
set.seed(1)
x <- data.frame(
  id = sample(1:15, size = 200, replace = TRUE),
  code = sample_diag(200),
  stringsAsFactors = FALSE
)
?comorbidity
elix = comorbidity(x = x, id = "id", code = "code", 
                   score = "elixhauser", assign0 = FALSE)
elix_ahrq = comorbidity(x = x, id = "id", code = "code", 
                   score = "elixhauser_ahrq", assign0 = FALSE)

# Compare scores
print(data.frame(elix_score = elix$score,
                 elix_ahrq_score = elix_ahrq$score))
```

Let's take a look at an observation with different scores (7):

```{r echo=F}
print("Unique ICDs for obs 7: ")
print(unique(x[x$id==7,'code']))

print("Elixhauser (original) comorbidity groups: ")
print(elix[elix$id==7,elix[elix$id==7,]!=0])
?rename
print("Elixhauser_ahrq comorbidity groups: ")
print(elix_ahrq[7, elix_ahrq[7,]!=0])
```

It's strange that chf, ld, and alcohol are missing from the ahrq version. Let's take a look at the lofregex to see if anything is wrong there.

```{r}
load('../R/sysdata.rda')
id7_icds = unique(x[x$id==7,'code']) # assign icd codes for id=7
# Print code/group combinations for original elixhauser
for (icd in id7_icds){
  for (c in names(lofregex[['elixhauser']][['icd10']])) {
    codes_string = lofregex[['elixhauser']][['icd10']][[c]]
    if (grepl(codes_string, icd)){
      print(paste0(icd,': ',c))
    }
  }
}

# Print code/group combinations for elixhauser_ahrq
for (icd in id7_icds){
  for (c in names(lofregex[['elixhauser_ahrq']][['icd10']])) {
    codes_string = lofregex[['elixhauser_ahrq']][['icd10']][[c]]
    if (grepl(codes_string, icd)){
      print(paste0(icd,': ',c))
    }
  }
}

```

This confirms that the ICD codes that flagged ld, chf, and alcohol in the original elixhauser icd mapping do not exist in the regex string for elixhauser_ahrq. I can also confirm that those codes do not exist in the SAS code mapping file at all:

```{r}
raw_sas = readLines('https://www.hcup-us.ahrq.gov/toolssoftware/comorbidityicd10/comformat_icd10cm_2020_1.txt')

for (icd in id7_icds) {
  print(paste0(icd, ': ', sum(grepl(icd, raw_sas))))
}
```

This confirms that the codes did not get lost in translation from SAS to R, either.

I'm guessing differences between the two mappings and subsequent scores are mainly due to the update's emphasis on avoiding including any ICD10 codes that are primary/acute conditions. 

```{r}
c("CHF", "VALVE", "PULMCIRC", "PERIVASC", "HTN", "HTNCX", "PARA",
  "NEURO", "CHRNLUNG", "DM", "DMCX", "HYPOTHY", "RENLFAIL", "LIVER",
  "ULCER", "AIDS", "LYMPH", "METS", "TUMOR", "ARTH", "COAG", "OBESE",
  "WGHTLOSS", "LYTES", "BLDLOSS", "ANEMDEF", "ALCOHOL", "DRUG", "PSYCH",
"DEPRESS")

c("chf",
"valv",
"pcd",
"pvd",
"hypunc",
"hypc",
"para",
"ond",
"cpd",
"diabunc",
"diabc",
"hypothy",
"rf",
"ld",
"pud",
"aids",
"lymph",
"metacanc",
"solidtum",
"rheumd",
"coag",
"obes",
"wloss",
"fed",
"blane",
"dane",
"alcohol",
"drug",
"psycho",
"depre")
```



